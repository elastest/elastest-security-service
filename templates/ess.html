<!DOCTYPE html>
  <html>
    <head>
      <title>ElasTest Security Service</title>
      <!--Import Google Icon Font-->
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
       <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <!--Import JQuery-->
      <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>	
      
      <script>
		api_version="r3";
		//Function to send API request with the entered tjob id
		function addTJobId(){
			return "/ess/api/"+api_version+"/secjobs/"+$("#tjobid").val()+"/exec";
		}
		//Function to update the progress bar of each test
		function changeProgress(element,percentage){
			$(element).attr("style", "width: "+percentage+"%");
		}
		//Function that appends each insecure URL to the UI
		function showReport(result_location){
			url= addTJobId();
			$.get(url, function(responseTxt, statusTxt, xhr){
			    if(statusTxt == "success"){
				for ( var i = 0, l = responseTxt.length; i < l; i++ ) {
			            
				    $(result_location).parent().siblings("div.collection").children().next().next().append("<div id=\"insecureurl\" style=\"color:red;\">"+responseTxt[i]+"</div>");
				}
				
			    }
			    if(statusTxt == "error")
				alert("Error: " + xhr.status + ": " + xhr.statusText);
			})
			
		}
		//Function that create a secjob by sending the secjob info entered by the tester
		function sendSecJob(){
			url= "/ess/api/"+api_version+"/secjobs";
			postbody={id: 0, name: $("#secjobname").val(), vulns:[],tJobId:$("#tjobid").val(),maxRunTimeInMins:10}
			$.ajax({
				    type: "POST",
				    url: url,
				    // The key needs to match your method's input parameter (case-sensitive).
				    data: JSON.stringify(postbody),
				    contentType: "application/json; charset=utf-8",
				    dataType: "json",
				    success: function(result){
						toast("SecJob Created Successfully!",4000);
						addToSecJobList(result.secjob);
						
					      },
				    failure: function(errMsg) {
					toast("SecJob Creation Failed! Please check your connection",4000);
					alert(errMsg);
				    }
			});
	
		}
		//Function to get tjob execution status
		r="";

		//Function that executes the tjob associated to the secjob under execution
		function executeTJob(tjobid,elem){
			url_start_exec= "/ess/api/"+api_version+"/tjobs/"+tjobid.toString()+"/exec";
			toast("Starting Executing TJob with id: "+tjobid.toString(),4000);
			start_exec=$.ajax({
				    type: "GET",
				    url: url_start_exec,
				    // The key needs to match your method's input parameter (case-sensitive).  
				    dataType: "json",
				    success: function(re){
						if(re.result=="IN PROGRESS"){
							toast("TJob Execution IN PROGRESS!",4000);
							tjobExecStatus(tjobid,re,elem);
						}
						else if(result.result=="FAILED"){
						}
						
					      },
				    failure: function(errMsg) {
					toast("TJob Execution Failed",4000);
					alert(errMsg);
				    }
			});	
		}
		
		function tjobExecStatus(tjobid,res,element){
			
			get_exec_progress=$.ajax({
						    type: "GET",
						    url: "/ess/api/"+api_version+"/tjobs/"+tjobid.toString()+"/exec/"+res.instance,
						    // The key needs to match your method's input parameter (case-sensitive).  
						    dataType: "json",
						    success: function(result1){
								r=result1.result.toString()
								console.log("out"+r)
								element.parentNode.nextSibling.nextSibling.firstChild.firstChild.innerHTML="TJob Execution Status: "+"<p style=\"color:blue\">"+r+"</p>"
								if (r=="STARTING TSS"){
									element.parentNode.nextSibling.nextSibling.firstChild.firstChild.nextSibling.firstChild.setAttribute("style","width: 10%");
								}
								else if (r=="WAITING TSS"){
									element.parentNode.nextSibling.nextSibling.firstChild.firstChild.nextSibling.firstChild.setAttribute("style","width: 20%");
								}
								else if (r=="EXECUTING TEST"){
									element.parentNode.nextSibling.nextSibling.firstChild.firstChild.nextSibling.firstChild.setAttribute("style","width: 30%");
								}
								else if (r=="FAIL"){
									element.parentNode.nextSibling.nextSibling.firstChild.firstChild.nextSibling.firstChild.setAttribute("style","width: 100%; background-color: red");
									return "FAIL"
									
								}
								else if (r=="ERROR"){
									element.parentNode.nextSibling.nextSibling.firstChild.firstChild.nextSibling.firstChild.setAttribute("style","width: 100%; background-color: red");
									return "ERROR"
									
								}
								else if (r=="SUCCESS"){
									element.parentNode.nextSibling.nextSibling.firstChild.firstChild.nextSibling.firstChild.setAttribute("style","width: 100%; background-color: green");
									showReport(element)
									return "SUCCESS"
									
								}
								//(r!="SUCCESS" && r!="FAIL" && r!="ERROR" && r!="FAILED")
								//for (i = 0; i < 2; i++){
									setTimeout(tjobExecStatus(tjobid,res,element), 10000);
								//}
							     },
						    failure: function(errMsg) {
							toast("TJob Execution Failed",4000);
							alert(errMsg);
							r="ERROR"
						    }
						});				
		}
		//Function that creates the contents of each stage of the secjob execution
		function addToSecJobList(secjob){
	
			
			retreived_secjob="<li id=\"secjob-individual\" class=\"collection-item avatar\" style=\"display: inherit\;\"><i class=\"material-icons circle\">receipt</i><span id=\"secjobid\" class=\"title\">SecJob Id: "+secjob.id+"</span><p id=\"sejobid\">SecJob Name: "+secjob.name+"<br> Associated TJob Id: "+secjob.tJobId+"</p><a href=\"#!\"class=\"secondary-content\"><i id=\"exe-sjob\" class=\"material-icons\">play_arrow</i><p>Execute</p></a></li>";
			
			$("#secjob-collection").append(retreived_secjob);
			$("#exe-sjob").click(function(){
			      secjobExecStat="<h5 align=\"center\">SecJob Execution</h5><div class=\"collection\"><a href=\"#!\" class=\"collection-item\"><p id=\"tjobexecstat\">TJob Execution Status</p><div class=\"progress\"><div class=\"determinate\" style=\"width: 0%\"></div></div></a><a href=\"#!\" class=\"collection-item\"><p id=\"trafficanstat\">HTTP Traffic Analysis Status</p><div class=\"progress\"><div class=\"determinate\" style=\"width: 0%\"></div></div></a><a href=\"#!\" class=\"collection-item\">Insecure URLs </a></div>"
			      showSecJobExecStat(this,secjobExecStat);
			      executeTJob(secjob.tJobId,this);
			      
			  });
		}
		//Function that displays the secjob execution status panel
		function showSecJobExecStat(position,exec_stats){		
			$(position).parent().parent().append(exec_stats);
		}
		

		//Function that lists the created secjob upon clicking the create button of the secjob
		$(document).ready(function(){
		  $("#secjob-collection").hide();
		  $("#create-sjob").click(function(){
		      $("#when-empty").hide();
		      $("#secjob-collection").show();
		      sendSecJob();
		  });
		

		});
      </script>
    </head>
    <body>
      <!--Import jQuery before materialize.js-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js">
      </script>
        <!-- LEFT LOGO -->
        <nav>
          <div class="nav-wrapper blue">
            <a href="" class="brand-logo">ElasTest Security Service</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
              <li><a class="active" href="#home">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>
            </ul>
          </div>
        </nav>
        <!-- SecJob Operations -->
        <div id="home">
          <ul class="collapsible" data-collapsible="accordion">
            <li>
              <div id="create-sec-job-panel" class="collapsible-header">
                <i class="material-icons">create</i>Create New SecJob
              </div>
              <div class="collapsible-body">
                <form>
                  <div class="input-field">
                    <input type="text" id="secjobname">
                    <label class="active" for="secjobname">SecJob Name*</label>
                  </div>
                  <div class="input-field">
                    <input type="text" id="tjobid">
                    <label class="active" for="tjobid">TJob ID*</label>
                  </div>
                  <div class="input-field">
                    <textarea type="text" id="secjobdesc" class="materialize-textarea"></textarea>
                    <label class="active" for="secjobdesc">SecJob Description</label>
                  </div>
                  <a id="create-sjob" class="btn">Create</a>
                </form>
              </div>
            </li>
	    <!-- List SecJobs with option to execute-->
	    <li>
              <div class="collapsible-header">
                <i class="material-icons">playlist_play</i>View & Execute SecJobs
              </div>

              <div class="collapsible-body">
	    <!-- List SecJobs -->
		 <p id="when-empty">No SecJobs found</p>
                 <ul id="secjob-collection" class="collection">
		    
		  </ul>
              </div>
            </li>
	    <!-- Help menu -->
            <li>
              <div class="collapsible-header active">
                <i class="material-icons">help</i>Help
              </div>
              <div class="collapsible-body">
                <span>The ElasTest Security Service can be used to identify insecure URLs and cookies of the web applications involved in a TJob.</span>
		<p><b>How to use?</b></p>
		<ul style="list-style-type:circle">
			<li>1. Go to the "Create New SecJob" section and create a new SecJob by providing the details of a TJob you created at TORM</li>
			<li>2. After entering the SecJob details, click the "Create" button. The SecJob you created now should be visible in the "View and Execute SecJobs" section</li>
			<li>3. From the "View & Execute SecJobs" section, click the "Execute" button corresponding to the SecJob you created</li>
			<li>4. The list of the insecure URLs and cookies should now appear</li>
		</ul> 
              </div>
            </li>
          </ul>
        </div>
        
        <!-- JQuery Operations -->
        <script type="text/javascript">
          function toast(message,time) {
            Materialize.toast(message, time, 'rounded')
          }
        </script>
    </body>
  </html>
